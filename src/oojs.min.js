/**
 * oojs.js
 * version 1.0.0
 * (C) 2017, Vikas Burman
 * MIT License 
 */
(function(){const def=(opts={})=>{let oojs={},isServer=!1,options={env:opts.env||(isServer?"server":"client"),global:!0,supressGlobals:"undefined"!=typeof opts.supressGlobals&&opts.supressGlobals,symbols:opts.symbols||[]};oojs.Class=((arg1,arg2,arg3,arg4)=>{let className=arg1,inherits=null,mixins=[],factory=null;"function"==typeof arg3?(factory=arg3,Array.isArray(arg2)?mixins=arg2:inherits=arg2):"function"==typeof arg4?(inherits=arg2,mixins=arg3,factory=arg4):"function"==typeof arg2&&(factory=arg2);let Class=function(_flag,_static,...args){let Parent=Class._.inherits,_this={},_exposed_this={},singleInstance=null,bucket=[],meta={},props={},events=[],classArgs=[],isNeedProtected=!1,staticInterface=null,theFlag="__flag__";if(singleInstance=Class._.singleInstance())return singleInstance;if(_flag&&_flag===theFlag?(staticInterface=_static,isNeedProtected=!0,classArgs=args):(staticInterface=Class._.static,_flag?(classArgs=classArgs.concat([_flag]),_static&&(classArgs=classArgs.concat([_static]),args&&(classArgs=classArgs.concat(args)))):classArgs=args),Parent&&(_this=new Parent(theFlag,staticInterface,...classArgs),Parent._.isSealed()||Parent._.isSingleton()))throw`${className} cannot inherit from a sealed/singleton class ${Parent._.name}.`;const isSingletonClass=()=>{return hasAttr("singleton",meta._constructor)},isSpecialMember=member=>{return["constructor","dispose","_constructor","_dispose","_"].indexOf(member)!==-1},isOwnMember=member=>{return"undefined"!=typeof meta[member]},isDerivedMember=member=>{return!isOwnMember(member)&&_this._.instanceOf.findIndex(item=>{return!!item.meta[member]})!==-1},isSealedMember=member=>{return hasAttr("sealed",meta[member])},isPrivateMember=(member=>{return hasAttr("static",meta[member])},member=>{return hasAttr("private",meta[member])}),isProtectedMember=member=>{return hasAttrEx("protected",member)},isSerializableMember=member=>{return hasAttrEx("serialize",member)},isConditionalMemberOK=member=>{let isOK=!0,_meta=meta[member],condition="";if(_meta)for(let item of _meta)if("conditional"===item.name){switch(isOK=!1,condition=item.args&&item.args.length>0?item.args[0]:""){case"server":isOK="server"===options.env;break;case"client":isOK="client"===options.env||""===options.env;break;default:isOK=options.symbols.indexOf(condition)!==-1}break}return isOK},doCopy=member=>{Object.defineProperty(_exposed_this,member,Object.getOwnPropertyDescriptor(_this,member))},isArrowFunction=fn=>{return!fn.hasOwnProperty("prototype")},attr=(attrName,...args)=>{attrName=attrName.replace("@",""),bucket.push({name:attrName,Attr:getAttr(attrName),args:args})},getAttr=attrName=>{return allAttributes[attrName]},getAttrArgs=(attrName,member)=>{let attrArgs=null;for(let item of _this._.instanceOf)if(item.meta[member]){for(let attrItem of item.meta[member])if(attrItem.name===attrName){attrArgs=attrItem.args;break}if(attrArgs)break}return null!==attrArgs?attrArgs:[]},applyAttr=targetName=>{let Attr=null,targetType=meta[targetName].type,attrArgs=null,attrInstance=null,decorator=null;for(let info of meta[targetName])if(Attr=info.Attr,Attr&&(attrArgs=info.args||[],attrInstance=new Attr(...attrArgs),decorator=attrInstance.decorator(),"function"==typeof decorator)){let descriptor=Object.getOwnPropertyDescriptor(_this,targetName);decorator(_this,targetType,targetName,descriptor),Object.defineProperty(_this,targetName,descriptor)}},hasAttr=(attrName,_meta)=>{let has=!1;return _meta&&(has=_meta.findIndex(item=>{return item.name===attrName})!==-1),has},hasAttrEx=(attrName,member)=>{return _this._.instanceOf.findIndex(item=>{return!!item.meta[member]&&hasAttr(attrName,item.meta[member])})!==-1},isPatternMatched=(pattern,name)=>{let isMatched="*"===pattern;return isMatched||(pattern.indexOf("*")!==-1?(pattern=pattern.replace("*","[\\w]"),pRegEx=new RegExp(pattern),isMatched=pRegEx.test(name)):isMatched=pattern===name),isMatched},applyAspects=(funcName,funcAspects)=>{let fn=_this[funcName],before=[],after=[],around=[],instance=null,_fn=null;for(let funcAspect of funcAspects)instance=new funcAspect,_fn=instance.before(),"function"==typeof _fn&&before.push(_fn),_fn=instance.around(),"function"==typeof _fn&&around.push(_fn),_fn=instance.after(),"function"==typeof _fn&&after.push(_fn);around.length>0&&around.reverse();let weavedFn=function(...args){let error=null,result=null,ctx={obj:()=>{return _this},className:()=>{return className},funcName:()=>{return funcName},error:err=>{return err&&(error=err),error},result:value=>{return"undefined"!=typeof value&&(result=value),result},args:()=>{return args},data:{}};for(let beforeFn of before)try{beforeFn(ctx)}catch(err){error=err}let newFn=fn;for(let aroundFn of around)newFn=aroundFn(ctx,newFn);try{ctx.result(newFn(...args))}catch(err){error=err}for(let afterFn of after)try{afterFn(ctx)}catch(err){error=err}return ctx.result()}.bind(_this);return weavedFn},getClassAspects=()=>{let classAspects={};for(let entry in allAspects)allAspects.hasOwnProperty(entry)&&isPatternMatched(entry.split(".")[0],className)&&(classAspects[entry]=allAspects[entry]);return classAspects},getFuncAspects=(classAspects,funcName)=>{let funcAspects=[];for(let entry in classAspects)classAspects.hasOwnProperty(entry)&&isPatternMatched(entry.split(".")[1],funcName)&&funcAspects.push(...classAspects[entry]);return funcAspects},weave=()=>{if(["Attribute","Aspect"].indexOf(className)===-1&&!_this._.isInstanceOf("Attribute")&&!_this._.isInstanceOf("Aspect")){let classAspects=getClassAspects(),funcAspects=[];for(let entry in meta)meta.hasOwnProperty(entry)&&"func"===meta[entry].type&&!isSpecialMember(entry)&&(funcAspects=getFuncAspects(classAspects,entry),funcAspects.length>0&&Object.defineProperty(_this,entry,{value:applyAspects(entry,funcAspects)}))}},processJson=(source,target,isDeserialize)=>{let mappedName="";for(member in _this)_this.hasOwnProperty(member)&&(!_this._.isProp(member)||!isSerializableMember(member)||_this._.isReadOnly(member)||_this._.isStatic(member)||isPrivateMember(member)||isProtectedMember(member)||isSpecialMember(member)||(mappedName=getAttrArgs("serialize",member)[0]||member,isDeserialize?target[member]=source[mappedName]||target[member]:target[mappedName]=source[member]))};if(_this.func=((name,fn)=>{if("_"===name)throw`${name} is not allowed.`;isSpecialMember(name)&&(name="_"+name),meta[name]=[].concat(bucket),meta[name].type="func",bucket=[];let attrs=meta[name];if(!isConditionalMemberOK(name))return void delete meta[name];if(hasAttr("override",attrs)){let desc=Object.getOwnPropertyDescriptor(_this,name);if("function"!=typeof desc.value)throw`${name} is not a function to override.`;if(hasAttrEx("sealed",name))throw`${name} cannot override a sealed function.`;let base=_this[name].bind(_this);Object.defineProperty(_this,name,{value:function(...args){let fnArgs=[base].concat(args);return isArrowFunction(fn)?fn(...fnArgs):fn.apply(_this,fnArgs)}.bind(_this)})}else{if("undefined"!=typeof _this[name])throw`${name} already defined.`;Object.defineProperty(_this,name,{configurable:!0,enumerable:!0,writable:!1,value:function(...args){return isArrowFunction(fn)?fn(...args):fn.apply(_this,args)}.bind(_this)})}applyAttr(name)}),_this.prop=((name,valueOrGetter,setter)=>{if(isSpecialMember(name))throw`${name} can only be defined as a function.`;"undefined"==typeof valueOrGetter&&"undefined"==typeof setter&&(valueOrGetter=null),meta[name]=[].concat(bucket),meta[name].type="prop",bucket=[];let attrs=meta[name];if(!isConditionalMemberOK(name))return void delete meta[name];if(hasAttr("override",attrs)){let desc=Object.getOwnPropertyDescriptor(_this,name);if("function"!=typeof desc.get)throw`Not a property to override. (${name})`;if(hasAttrEx("sealed",name))throw`Cannot override a sealed property. (${name})`;if(hasAttrEx("static",name))throw`Cannot override a static property. (${name})`}else if("undefined"!=typeof _this[name])throw`${name} already defined.`;if("function"!=typeof valueOrGetter){let propHost=null;hasAttrEx("static",name)?(propHost=staticInterface,propHost[name]||(propHost[name]=valueOrGetter)):(propHost=props,propHost[name]=valueOrGetter),Object.defineProperty(_this,name,{__proto__:null,configurable:!0,enumerable:!0,get:()=>{return propHost[name]},set:hasAttr("readonly",attrs)?value=>{throw`${name} is readonly.`}:value=>{propHost[name]=value}})}else{if(hasAttr("static",attrs))throw`Static properties cannot be defined with a getter/setter. (${name})`;Object.defineProperty(_this,name,{__proto__:null,configurable:!0,enumerable:!0,get:valueOrGetter,set:hasAttr("readonly",attrs)?value=>{throw`${name} is readonly.`}:value=>{"function"==typeof setter&&setter(value)}})}applyAttr(name)}),_this.event=(name=>{if(isSpecialMember(name))throw`${name} can only be defined as a function.`;if("undefined"!=typeof _this[name])throw`${name} already defined.`;meta[name]=[],meta[name].type="event",bucket.length>0&&(console.warn(`Attributes can only be applied to properties or functions. ${name} is an event.`),bucket=[]);let _event=(...args)=>{let e={name:name,args:args,stop:!1};for(let handler of events)if(handler(e),e.stop)break};_event.subscribe=(fn=>{events.push(fn)}),_event.unsubscribe=(fn=>{let index=events.indexOf(fn);index!==-1&&events.splice(index,1)}),_event.unsubscribe.all=(()=>{events=[]}),Object.defineProperty(_this,name,{configurable:!1,enumerable:!0,value:_event,writable:!1})}),_this._=_this._||{},_this._.instanceOf=_this._.instanceOf||[],inherits||_this._.instanceOf.push({name:"Object",type:Object,meta:[],mixins:[]}),_this._.instanceOf.push({name:className,type:Class,meta:meta,mixins:mixins}),_this._.inherits=Class,_this._.isInstanceOf=(name=>{return _this._.instanceOf.findIndex(item=>{return item.name===name})!==-1}),_this._.isImplements=(name=>{let result=!1;for(let item of _this._.instanceOf)for(let mixin of item.mixins){if(mixin._.name===name){result=!0;break}if(result)break}return result}),_this._.isProp=(memberName=>{return"prop"===_this._.typeOf(memberName)}),_this._.isFunc=(memberName=>{return"func"===_this._.typeOf(memberName)}),_this._.isEvent=(memberName=>{return"event"===_this._.typeOf(memberName)}),_this._.isASync=(memberName=>{return hasAttrEx("async",memberName)}),_this._.isReadOnly=(memberName=>{return hasAttrEx("readonly",memberName)}),_this._.isStatic=(memberName=>{return hasAttrEx("static",memberName)}),_this._.isSingleton=(()=>{return null!==Class._.singleInstance()}),_this._.isDeprecated=(memberName=>{return hasAttrEx("deprecate",memberName)}),_this._.isEnumerable=(memberName=>{return!!_this[memberName]&&Object.getOwnPropertyDescriptor(_this,memberName).enumerable}),_this._.typeOf=(memberName=>{let result="";for(let item of _this._.instanceOf)item.meta[memberName]&&(result=item.meta[memberName].type);return result}),_this._.serialize=(()=>{let json={};return processJson(_this,json),json}),_this._.deserialize=(json=>{processJson(json,_this,!0)}),factory.apply(_this,[attr]),0!==mixins.length)for(let mixin of mixins)mixin.apply(_this,[attr]);if(delete _this.func,delete _this.prop,delete _this.event,"function"==typeof _this._constructor&&(_this._constructor(...classArgs),delete _this._constructor),"function"==typeof _this._dispose){_this._.dispose=_this._.dispose||[];let dispose=_this._dispose;_this._.dispose.push(dispose),delete _this._dispose}weave();let isCopy=!1;doCopy("_");for(let member in _this)isCopy=!1,_this.hasOwnProperty(member)&&!isSpecialMember(member)&&(isCopy=!0,isOwnMember(member)?(isPrivateMember(member)&&(isCopy=!1),isCopy&&isProtectedMember(member)&&!isNeedProtected&&(isCopy=!1)):(isProtectedMember(member)&&!isNeedProtected&&(isCopy=!1),isCopy&&!isDerivedMember(member)&&(isCopy=!1))),isCopy&&doCopy(member);for(let member in _exposed_this)!isSpecialMember(member)&&isOwnMember(member)&&isSealedMember(member)&&Object.defineProperty(_exposed_this,member,{configurable:!1});return isSingletonClass()?(Class._.isSingleton=(()=>{return!0}),Class._.singleInstance=(()=>{return Object.freeze(_exposed_this)}),Class._.singleInstance()):isSealedMember("_constructor")?(Class._.isSealed=(()=>{return!0}),Object.freeze(_exposed_this)):_exposed_this};return Class._={inherits:inherits,mixins:mixins,name:className,singleInstance:()=>{return null},isSingleton:()=>{return!1},isSealed:()=>{return!1},isDerivedFrom:name=>{let result="Object"===name,prv=inherits;if(!result)for(;;){if(null===prv)break;if(prv._.name===name){result=!0;break}prv=prv._.inherits}return result},isImplements:name=>{let result=!1;for(let mixin of mixins)if(mixin._.name===name){result=!0;break}return result},static:{}},Class}),oojs.using=((obj,where)=>{try{where(obj)}finally{if(obj._&&obj._.dispose&&obj._.dispose.length>0){obj._.dispose.reverse();for(let dispose of obj._.dispose)dispose()}}}),oojs.Mixin=((mixinName,factory)=>{return factory._={name:mixinName},factory});let allAttributes={};oojs.Attributes=(Attribute=>{if(allAttributes[Attribute._.name])throw`${Attribute._.name} already registered.`;allAttributes[Attribute._.name]=Attribute}),oojs.Attribute=oojs.Class("Attribute",function(){let decoratorFn=null;this.func("constructor",(...args)=>{this.args=args}),this.prop("args",[]),this.func("decorator",fn=>{return"function"==typeof fn&&(decoratorFn=fn),decoratorFn}),this.func("resetEventInterface",(source,target)=>{target.subscribe=source.subscribe,target.unsubscribe=source.unsubscribe,delete source.subscribe,delete source.unsubscribe})}),oojs.Attributes(oojs.Class("async",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func"].indexOf(type)===-1)throw`@async attribute cannot be applied on ${type} members. (${name})`;if(["_constructor","_dispose"].indexOf(type)!==-1)throw`@async attribute cannot be applied on special function. (${name})`;let fn=descriptor.value;descriptor.value=function(...args){return new Promise((resolve,reject)=>{let fnArgs=[resolve,reject].concat(args);fn(...fnArgs)})}.bind(obj)})})),oojs.Attributes(oojs.Class("deprecate",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["_constructor","_dispose"].indexOf(type)!==-1)throw`@deprecate attribute cannot be applied on special function. (${name})`;let msg=`${name} is deprecated. ${this.args[0]}`||`${name} is deprecated.`;switch(type){case"prop":if(descriptor.get){let _get=descriptor.get;descriptor.get=function(){return console.warn(msg),_get()}.bind(obj)}if(descriptor.set){let _set=descriptor.set;descriptor.set=function(value){return console.warn(msg),_set(value)}.bind(obj)}break;case"func":let fn=descriptor.value;descriptor.value=function(...args){console.warn(msg),fn(...args)}.bind(obj);break;case"event":let ev=descriptor.value;descriptor.value=function(...args){console.warn(msg),ev(...args)}.bind(obj),this.resetEventInterface(fn,descriptor.value)}})})),oojs.Attributes(oojs.Class("enumerate",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["_constructor","_dispose"].indexOf(type)!==-1)throw`@enumerate attribute cannot be applied on special function. (${name})`;let flag=this.args[0];descriptor.enumerable=flag})})),oojs.Attributes(oojs.Class("inject",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func","prop"].indexOf(type)===-1)throw`@inject attribute cannot be applied on ${type} members. (${name})`;if(["_constructor","_dispose"].indexOf(name)!==-1)throw`@inject attribute cannot be applied on special function. (${name})`;let Type=this.args[0],typeArgs=this.args[1],instance=null;if(Array.isArray(typeArgs)||(typeArgs=[typeArgs]),"string"==typeof Type){if(Type.indexOf("|")!==-1){let items=Type.split("|");Type="server"===options.env?items[0].trim():items[1].trim()}instance=oojs.Container.resolve(Type,!1,...typeArgs)}else instance=new Type(...typeArgs);switch(type){case"func":let fn=descriptor.value;descriptor.value=function(...args){fn(instance,...args)}.bind(obj);break;case"prop":obj[name]=instance}})})),oojs.Attributes(oojs.Class("multiinject",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func","prop"].indexOf(type)===-1)throw`@multiinject attribute cannot be applied on ${type} members. (${name})`;if(["_constructor","_dispose"].indexOf(name)!==-1)throw`@multiinject attribute cannot be applied on special function. (${name})`;let Type=this.args[0],typeArgs=this.args[1],instance=null;if(Array.isArray(typeArgs)||(typeArgs=[typeArgs]),"string"!=typeof Type)throw`@multiinject attribute does not support direct type injections. (${name})`;if(Type.indexOf("|")!==-1){let items=Type.split("|");Type="server"===options.env?items[0].trim():items[1].trim()}switch(instance=oojs.Container.resolve(Type,!0,...typeArgs),type){case"func":let fn=descriptor.value;descriptor.value=function(...args){fn(instance,...args)}.bind(obj);break;case"prop":obj[name]=instance}})}));let allAspects={};oojs.Aspects=((pointcut,Aspect)=>{allAspects[pointcut]||(allAspects[pointcut]=[]),allAspects[pointcut].push(Aspect)}),oojs.Aspect=oojs.Class("Aspect",function(){let beforeFn=null,afterFn=null,aroundFn=null;this.func("constructor",(...args)=>{this.args=args}),this.prop("args",[]),this.func("before",fn=>{return"function"==typeof fn&&(beforeFn=fn),beforeFn}),this.func("after",fn=>{return"function"==typeof fn&&(afterFn=fn),afterFn}),this.func("around",fn=>{return"function"==typeof fn&&(aroundFn=fn),aroundFn})});let container={};if(oojs.Container=((typeName,cls)=>{container[typeName]||(container[typeName]=[]),container[typeName].push(cls)}),oojs.Container.resolve=((typeName,isMultiResolve,...args)=>{let result=null;if(container[typeName]&&container[typeName].length>0)if(isMultiResolve){result=[];for(let Type of container[typeName])result.push(new Type(...args))}else{let Type=container[typeName][0];result=new Type(...args)}return result}),oojs.Container.request=((typeAMDModuleUrl,...args)=>{return new Promise((resolve,reject)=>{require([typeAMDModuleUrl],Type=>{resolve(new Type(...args))},reject)})}),oojs.Serializer={serialize:instance=>{return instance._.serialize()},deserialize:(Type,json)=>{let instance=new Type;return instance._.deserialize(json),instance}},!options.supressGlobals){let g=options.global;g.Class=oojs.Class,g.using=oojs.using,g.Attribute=oojs.Attribute,g.Attributes=oojs.Attributes,g.Aspect=oojs.Aspect,g.Aspects=oojs.Aspects,g.Container=oojs.Container,g.Serializer=oojs.Serializer,g.Mixin=oojs.Mixin}return Object.freeze(oojs)};"object"==typeof("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=def:"function"==typeof define&&"undefined"!=typeof define.amd?define(function(){return def}):this.oojs=def}).call(this);
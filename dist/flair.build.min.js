/**
 * @preserve
 * FlairJS
 * True Object Oriented JavaScript
 * 
 * Assembly: flair.build
 *     File: ./flair.build.js
 *  Version: 0.15.140
 *  Wed, 20 Feb 2019 00:01:18 GMT
 * 
 * (c) 2017-2019 Vikas Burman
 * Licensed under MIT
 */
const e=require("recursive-readdir-sync"),n=require("copy-dir"),i=require("path"),t=require("fs-extra"),r=require("del"),s=new require("eslint").CLIEngine,o=require("uglify-js-harmony");let c,a,f,u,l=!1,p,d=["flair","flair.build"],g=null,y=(e,n)=>{const r=()=>{return t.readdirSync(e).filter(n=>{return t.statSync(i.join(e,n)).isDirectory()})};return n?r():["/"].concat(r())},h=e=>{r.sync([e+"/**","!"+e])};const S=(e,i)=>{e.length>0&&N(`      deps: ${e.length}`);const r=e=>{if(0!==e.length){let i=e.shift();if(N(`            - ${i.dest}
`),i.src.startsWith("http")){let n=null,s="";n=i.src.startsWith("https")?require("https"):require("http"),n.get(i.src,n=>{n.on("data",e=>{s+=e}),n.on("end",()=>{t.ensureFileSync(i.dest),t.writeFileSync(i.dest,s,"utf8"),r(e)})}).on("error",e=>{throw`Failed to fetch dependency: ${i.src}. 

 ${e}`})}else t.lstatSync(i.src).isDirectory()?n.sync(i.src,i.dest):t.copyFileSync(i.src,i.dest),r(e)}else i()};r(e.slice())},m=e=>{return e.replace(/([.*+?\^=!:${}()|\[\]\/\\])/g,"\\$1")},j=(e,n,i)=>{return e.replace(new RegExp(m(n),"g"),i)},w=(e,n)=>{const r="\\s*([\\w@_\\-.\\\\/]+)\\s*",s="<filename>",o="<!--\\s*inject:<filename>-->",c="^([ \\t]*)(.*?)"+o.replace(s,r),a=new RegExp(c,"m");let f,u,l,p,d;for(;p=a.exec(n);){d=p[0],l=p[1],u=p[2],f=p[3];var g=l+u+t.readFileSync(i.join(e,f),"utf8").split(/\r?\n/).map((e,n)=>{return n>0?l+e:e}).join("\n");n=n.replace(d,function(){return g})}return n},x=e=>{let n=u.version.split(".");n[0]=parseInt(n[0]),n[1]=parseInt(n[1]),n[2]=parseInt(n[2]),n[2]>=99999?(n[2]=0,n[1]>=999?(n[1]=0,n[0]+=1):n[1]+=1):n[2]+=1;let i=n[0].toString()+"."+n[1].toString()+"."+n[2].toString();return u.version=i,t.writeFileSync(e,JSON.stringify(u,null,4),"utf8"),i},N=e=>{l||console.log(e)},F=(r,s,a,f,l,S)=>{const m=(e,n,i=true)=>{i?t.writeFileSync(e,n,{flag:"a"}):t.writeFileSync(e,n)},x=(e,n)=>{let i=`/**
`+` * @preserve
`+` * ${u.title}
`+` * ${u.description}
`+` * 
`+` * Assembly: ${n}
`+` *     File: ${e.replace(f,".")}
`+` *  Version: ${u.version}
`+` *  ${(new Date).toUTCString()}
`+` * 
`+` * ${u.copyright}
`+` * Licensed under ${u.license}
`+` */
`;m(e,i)},F=(e,n)=>{let i=`(() => {
`+`   const { $$, attr, Class, Struct, Enum, Interface, Mixin, Exception, Args } = flair; // eslint-disable-line no-unused-vars
`+`   const { Aspects, Assembly, Resource, Namespace, Container, Reflector, Serializer } = flair;   // eslint-disable-line no-unused-vars
`+`   const { getAttr, getAssembly, getResource, getTypeOf } = flair;                     // eslint-disable-line no-unused-vars
`+`   const { getType, typeOf, as, is, isDerivedFrom, isInstanceOf, isComplies, isImplements, isMixed } = flair;  // eslint-disable-line no-unused-vars
`+`   const { include, dispose, using, on, dispatch } = flair;                            // eslint-disable-line no-unused-vars
`+`   const { noop, telemetry } = flair;                                                  // eslint-disable-line no-unused-vars
`+`   const { isServer } = flair.options.env;                                             // eslint-disable-line no-unused-vars
`+`
`;n?i+=`   const settings = JSON.parse('${n}'); // eslint-disable-line no-unused-vars
`:`   const settings = {}; // eslint-disable-line no-unused-vars
`,m(e,i)},O=e=>{let n=`
`+`})();
`;m(e,n)},C=(e,n,i)=>{if(d.indexOf(i)===-1){let t={name:i,file:n.replace(".js","{.min}.js").replace(f,"."),desc:u.description,version:u.version,copyright:u.copyright,license:u.license,types:[],resources:[],assets:[]};return e.push(t),t}},b=(e,n,i,t)=>{if(d.indexOf(n)===-1)if(["types","resources","assets"].indexOf(i)!==-1){if(e[i].indexOf(t)!==-1)throw`Member is already added/associated with assembly. (${t})`;e[i].push(t)}else e[i]=t},P=(e,r,s,o)=>{t.existsSync(s)&&(N(`    assets: ${s.replace(a,".")}`),t.ensureDirSync(o),n.sync(s,o,function(n,t,s){return"file"===n&&(b(e,r,"assets","./"+s),N("            - ./"+i.join(o.replace(f,"./")+"/"+s))),!0},function(e){throw e}))},q=(e,n)=>{return t.existsSync(n)?(N("  settings: "+n.replace(a,".")),JSON.stringify(JSON.parse(t.readFileSync(n)))):""},J=(e,n,i,t,r,s)=>{e.push({ado:n,asmName:i,asm:t,file:r,qualifiedName:s})},v=(e,n,r,s,o)=>{let c="",u="",p=i.extname(s).toLowerCase();b(e,n,"resources",o),l.indexOf(p)===-1?(c=t.readFileSync(s,"utf8"),u="utf8;"):(c=t.readFileSync(s),u=""),c=new Buffer(c).toString("base64"),u+="base64;";let d=`flair.Resource.register("${o}", "${u}", "${s.replace(f,".")}", "${c}");
`;m(r,d),N("            - "+o+" ("+s.replace(a,".")+")")},W=e=>{if(e.length>0){N(` resources: ${e.length}`);for(let n of e)v(n.ado,n.asmName,n.asm,n.file,n.qualifiedName)}},k=(e,n,i,t,r,s,o,c,a)=>{e.push({ado:n,asmName:i,asm:t,file:r,basepath:s,nsName:o,typeName:c,qualifiedName:a})},E=(e,n,i,r,s,o,c,f)=>{b(e,n,"types",f);let u=t.readFileSync(r,"utf8");u=j(u,`$$('ns', '(auto)');`,`$$$('ns', '${o}');`),u=j(u,`$$("ns", "(auto)");`,`$$$("ns", "${o}");`),u=j(u,`Class('(auto)'`,`Class('${c}'`),u=j(u,`Class("(auto)"`,`Class("${c}"`),u=j(u,`Struct('(auto)'`,`Struct('${c}'`),u=j(u,`Struct("(auto)"`,`Struct("${c}"`),u=j(u,`Mixin('(auto)'`,`Mixin('${c}'`),u=j(u,`Mixin("(auto)"`,`Mixin("${c}"`),u=j(u,`Enum('(auto)'`,`Enum('${c}'`),u=j(u,`Enum("(auto)"`,`Enum("${c}"`),u=j(u,`Interface('(auto)'`,`Interface('${c}'`),u=j(u,`Interface("(auto)"`,`Interface("${c}"`),u=A(s,u),m(i,u),N("            - "+f+" ("+r.replace(a,".")+")")},L=(e,n,t,r)=>{if(e.length>0){N(`     types: ${e.length}`);let s=i.join(r,t,"settings.json");F(n,q(t,s));for(let o of e)E(o.ado,o.asmName,o.asm,o.file,o.basepath,o.nsName,o.typeName,o.qualifiedName);O(n)}},_=(e,n,i)=>{if(d.indexOf(i)===-1){N("   selfreg: yes");let i=`flair.Assembly.register('${JSON.stringify(e)}');
`;m(n,i)}},R=(e,n,i)=>{if(t.existsSync(n)){let r=t.readFileSync(n,"utf8");r=A(i,r),m(e,r),N("     index: "+n.replace(a,"."))}},A=(e,n)=>{return w(e,n)},D=e=>{let n=p.executeOnFiles([e]);if((n.errorCount>0||n.warningCount>0)&&(N(g(n.results)),n.errorCount>0))throw`${n.errorCount} Linting errors found.`},G=(e,n)=>{let i=o.minify([e],c);if(i.error)throw`Error minifying ${e}. 

 ${i.error}`;t.writeFileSync(n,i.code)},I=(e,n)=>{if(0!==e.length){N(`
  preamble: ${n.replace(f,".")}`);let i=JSON.stringify(e),r=`(() => { let ados = JSON.parse('${i}');flair.Assembly.register(ados);})();`;t.writeFileSync(n,r)}},T=(n,r)=>{"."!==n.replace(a,".")&&N(`
     group: ${n.replace(a,".")} (start)`);let s=[],o=i.join(r,"preamble.js"),c=y(n,!0);for(let u of c)if(!u.startsWith("_")){N("\n       asm: "+u);let o=i.join(r,u+".js"),c=[],a=[];t.ensureFileSync(o),x(o,u);let l=i.join(n,u,"index.js"),p=i.join(n,u);R(o,l,p);let d=C(s,o,u),g=y(i.join(n,u),!0);for(let h of g)if(!h.startsWith("_")){let t="",r="",s=i.join(n,u,h),f=e(s),l="";for(let p of f)if(t=i.extname(p).toLowerCase(),p.indexOf("/_")===-1&&!p.endsWith(".spec.js"))if(p.endsWith(".res.js")){if(r=i.basename(p).replace(".res.js",""),r.indexOf(".")!==-1)throw`Resource name cannot contain dots. (${r})`;l=("(root)"!==h?h+".":"")+r,J(c,d,u,o,p,l)}else if(p.endsWith(".js")){if(r=i.basename(p).replace(".js",""),r.indexOf(".")!==-1)throw`Type name cannot contain dots. (${r})`;l=("(root)"!==h?h+".":"")+r,k(a,d,u,o,p,s,h,r,l)}else{if(!p.endsWith(".res"+t))continue;if(r=i.basename(p).replace(".res"+t,""),r.indexOf(".")!==-1)throw`Resource name cannot contain dots. (${r})`;l=("(root)"!==h?h+".":"")+r,J(c,d,u,o,p,l)}}let S=i.join(n,u,"_assets"),m=i.join(r,u);P(d,u,S,m),L(a,o,u,n),W(c),_(d,o,u),D(o);let j=o.replace(".js",".min.js");G(o,j);let w=t.statSync(o),F=t.statSync(j);N("       ==>: "+o.replace(f,".")+" ("+Math.round(w.size/1024)+"kb, "+Math.round(F.size/1024)+"kb minified)")}I(s,o),"."!==n.replace(a,".")&&N(`
     group: ${n.replace(a,".")} (end)`)};h(f);let B,z="";for(let M of r)B=M,B.startsWith("_")||(z=M.replace(a,f),T(B,z));"function"==typeof S&&S()};module.exports=function(e,n){"function"==typeof e&&(n=e,e={}),e=e||{},e.suppressLogging=e.suppressLogging||!1,e.rootPath=e.rootPath||process.cwd(),e.src=e.src||i.join(e.rootPath,"src"),e.dest=e.dest||i.join(e.rootPath,"dist"),e.processAsGroups=e.processAsGroups||!1,e.uglifyConfig=e.uglifyConfig||i.join(e.rootPath,"build/config/.uglify.json"),e.eslintConfig=e.eslintConfig||i.join(e.rootPath,"build/config/.eslint.json"),e.depsConfig=e.depsConfig||i.join(e.rootPath,"build/config/.deps.json"),e.packageJSON=e.packageJSON||i.join(e.rootPath,"package.json"),e.utf8EncResFileTypes=[".txt",".xml",".js",".md",".json",".css",".html",".svg"].concat(e.utf8EncResFileTypes||[]),e.cb=e.cb||n,c=JSON.parse(t.readFileSync(e.uglifyConfig,"utf8")),a=JSON.parse(t.readFileSync(e.eslintConfig,"utf8")),f=JSON.parse(t.readFileSync(e.depsConfig,"utf8")),u=JSON.parse(t.readFileSync(e.packageJSON,"utf8")),l=e.suppressLogging,N("\nflairBuild: start\n"),N(`   grouped: ${e.processAsGroups?"yes":"no"}`),N(`      root: ${e.rootPath}`),N(`       src: ${e.src.replace(e.rootPath,".")}`),N(`      dest: ${e.dest.replace(e.rootPath,".")}`),N(`      deps: ${e.depsConfig.replace(e.rootPath,".")}`),N(`    verify: ${e.eslintConfig.replace(e.rootPath,".")}`),N(`    minify: ${e.uglifyConfig.replace(e.rootPath,".")}
`),p=new s(a),g=p.getFormatter();let r=()=>{let i=[];e.processAsGroups?i=y(e.src,!0):i.push(e.src);let t=u.version,r=x(e.packageJSON);N(`   version: ${t} -> ${r}`),F(i,e.rootPath,e.src,e.dest,e.utf8EncResFileTypes,()=>{N("\nflairBuild: end\n"),"function"==typeof n&&n()})};f.update?S(f.deps,r):r()};
/**
 * @preserve
 * Flair.js
 * True Object Oriented JavaScript
 * 
 * Assembly: flair.server
 *     File: ./flair.server.js
 *  Version: 0.6.0
 *  Sat, 11 May 2019 01:25:28 GMT
 * 
 * (c) 2017-2019 Vikas Burman
 * MIT
 */
!function(e,t){"use strict";"function"==typeof!0&&(!0).amd?(!0)(t):"object"==typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),module.exports=exports=t):e["flair.server"]=t}(this,async function(e){"use strict";const t=void 0!==!0?require("flairjs"):(!0).flair,{Class:r,Struct:s,Enum:n,Interface:o,Mixin:i,Aspects:a,AppDomain:l,$$:p,attr:c,bring:u,Container:d,include:f,Port:v,on:h,post:$,telemetry:m,Reflector:y,Serializer:g,Tasks:w,as:b,is:x,isComplies:S,isDerivedFrom:R,isAbstract:O,isSealed:A,isStatic:E,isSingleton:I,isDeprecated:j,isImplements:P,isInstanceOf:H,isMixed:T,getAssembly:B,getAttr:F,getContext:M,getResource:C,getRoute:k,getType:z,ns:N,getTypeOf:D,getTypeName:V,typeOf:L,dispose:J,using:W,Args:q,Exception:K,noop:U,nip:G,nim:Q,nie:X,event:Y}=t,{TaskInfo:Z}=t.Tasks,{env:_}=t.options,{forEachAsync:ee,replaceAll:te,splitAndTrim:re,findIndexByProp:se,findItemByProp:ne,which:oe,guid:ie,isArrowFunc:ae,isASyncFunc:le,sieve:pe,deepMerge:ce,b64EncodeUnicode:ue,b64DecodeUnicode:de}=t.utils,{$$static:fe,$$abstract:ve,$$virtual:he,$$override:$e,$$sealed:me,$$private:ye,$$privateSet:ge,$$protected:we,$$protectedSet:be,$$readonly:xe,$$async:Se,$$overload:Re,$$enumerate:Oe,$$dispose:Ae,$$post:Ee,$$on:Ie,$$timer:je,$$type:Pe,$$args:He,$$inject:Te,$$resource:Be,$$asset:Fe,$$singleton:Me,$$serialize:Ce,$$deprecate:ke,$$session:ze,$$state:Ne,$$conditional:De,$$noserialize:Ve,$$ns:Le}=p,Je=_.isServer||_.isWorker?null:(!0).document,We=l.context.current().name,qe=e,Ke=qe.substr(0,qe.lastIndexOf("/")+1);l.loadPathOf("flair.server",Ke);let Ue=JSON.parse('{"types":{"server":"flair.app.server.ExpressServer"},"express":{"server-http":{"enable":false,"port":80,"timeout":-1},"server-https":{"enable":false,"port":443,"timeout":-1,"privateKey":"","publicCert":""}},"envVars":{"vars":[],"options":{"overwrite":true}},"routing":{"mounts":{"main":"/"},"main-appSettings":[],"main-middlewares":[],"main-interceptors":[]}}'),Ge=t.Port("settingsReader");if("function"==typeof Ge){let e=Ge("flair.server");e&&(Ue=ce([Ue,e],!1))}Ue=Object.freeze(Ue);let Qe=JSON.parse("{}");Qe=Object.freeze(Qe),l.context.current().currentAssemblyBeingLoaded("./flair.server{.min}.js"),await(async()=>{const e=await f("fs | x"),t=await f("http | x"),r=await f("https | x"),s=await f("http-shutdown | x");p("ns","flair.app.server"),i("ExpressServer",function(){let n=null,o=null,i=Ue.express["server-http"],a=Ue.express["server-https"];p("override"),this.start=(async p=>{if(p(),i.enable&&(n=t.createServer(this.app),(n=s(n)).on("error",e=>{this.error(e)}),-1!==i.timeout&&(n.timeout=i.timeout)),a.enable){const t=e.readFileSync(l.resolvePath(a.privateKey),"utf8"),n=e.readFileSync(l.resolvePath(a.publicCert),"utf8"),i={key:t,cert:n};o=r.createServer(i,this.app),(o=s(o)).on("error",e=>{this.error(e)}),-1!==a.timeout&&(o.timeout=a.timeout)}}),p("override"),this.ready=(e=>new Promise((t,r)=>{e();let s=i.port||80,p=process.env.PORT||a.port||443;n&&o?n.listen(s,()=>{o.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${s}, https: ${p})`),t()})}):n?n.listen(s,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (http: ${s})`),t()}):o?o.listen(p,()=>{console.log(`${l.app().info.name}, v${l.app().info.version} (https: ${p})`),t()}):(console.log(`${l.app().info.name}, v${l.app().info.version}`),t())})),p("override"),this.stop=(async e=>{e(),n&&(console.log("http server is shutting down..."),n.shutdown(()=>{n=null,console.log("http server is cleanly shutdown!")})),o&&(console.log("https server is shutting down..."),o.shutdown(()=>{o=null,console.log("https server is cleanly shutdown!")}))})})})(),await(async()=>{const{Host:e}=N("flair.app"),t=await f(Ue.types.server||"flair.app.server.ExpressServer"),s=await f("express | x");p("sealed"),p("ns","flair.app"),r("ServerHost",e,[t],function(){let e={};p("override"),this.construct=(e=>{e("Express","4.x")}),this.app={get:()=>this.mounts["main"].app,set:U},this.mounts={get:()=>e,set:U},p("override"),this.boot=(async t=>{t();const r=(e,t)=>{let r=Ue[`${e}-appSettings`];if(r&&r.length>0)for(let e of r)t.set(e.name,e.value)};let n=s();r("main",n);let o="",i=null;for(let t of Object.keys(Ue.routing.mounts))"main"===t?(o="/",i=n):(o=Ue.routing.mounts[t],i=s()),e[t]=Object.freeze({name:t,root:o,app:i}),"main"!==t&&(r(t,i),n.use(o,i));e=Object.freeze(e)}),p("override"),this.dispose=(t=>{t(),e=null})})})(),await(async()=>{const{Handler:e}=N("flair.app");p("ns","flair.api"),r("RestHandler",e,function(){p("virtual"),this.get=U,p("virtual"),this.post=U,p("virtual"),this.put=U,p("virtual"),this.delete=U})})(),await(async()=>{p("ns","flair.api"),r("RestInterceptor",function(){p("virtual"),p("async"),this.run=U})})(),await(async()=>{const{Bootware:e}=N("flair.app");p("sealed"),p("ns","flair.boot"),r("Middlewares",e,function(){p("override"),this.construct=(e=>{e("Express Middlewares",!0)}),p("override"),this.boot=(async(e,t)=>{e();let r=Ue[`${t.name}-middlewares`];if(r&&r.length>0){let e=null,s=null;for(let n of r)if(n.name)try{e=require(n.name),s=n.func?e[n.func]:e;let r=[],o=null;n.args=n.args||[];for(let e of n.args){if("string"==typeof e&&e.startsWith("return "))o=new Function(e)();else if("object"==typeof e){for(let t in e)e.hasOwnProperty(t)&&"string"==typeof(o=e[t])&&o.startsWith("return ")&&(o=new Function(e)(),e[t]=o);o=e}else o=e;r.push(o)}t.app.use(s(...r))}catch(e){throw K.OperationFailed(`Middleware ${n.module} load failed.`,e,this.boot)}}})})})(),await(async()=>{const e=await f("node-env-file | x"),{Bootware:t}=N("flair.app");p("sealed"),p("ns","flair.boot"),r("NodeEnv",t,function(){p("override"),this.construct=(e=>{e("Node Server Environment")}),p("override"),this.boot=(async t=>{if(t(),Ue.envVars.vars.length>0)for(let t of Ue.envVars.vars)e(l.resolvePath(t),Ue.envVars.options)})})})(),await(async()=>{const{Bootware:e}=N("flair.app");p("sealed"),p("ns","flair.boot"),r("ResHeaders",e,function(){p("override"),this.construct=(e=>{e("Server Response Headers",!0)}),p("override"),this.boot=(async(e,t)=>{e();let r=Ue[`${t.name}-resHeaders`];r&&r.length>0&&t.app.use((e,t,s)=>{for(let e of r)t.setHeader(e.name,e.value);s()})})})})(),await(async()=>{const{Bootware:e}=N("flair.app"),{RestHandler:t,RestInterceptor:s}=N("flair.api");p("sealed"),p("ns","flair.boot"),r("ServerRouter",e,function(){let e=null;p("override"),this.construct=(e=>{e("Server Router",!0)}),p("override"),this.boot=(async(r,n)=>{r(),e||(e=l.context.current().allRoutes(!0)).sort((e,t)=>e.index<t.index?-1:e.index>t.index?1:0);let o=!1;const i=(e,t,r)=>new Promise((s,n)=>{try{let o;(new e).run(t,r).then(()=>{t.$stop?n():s()}).catch(n)}catch(e){n(e)}}),a=(e,t,r)=>ee(e,(e,n,o)=>{f(o).then(a=>{let l=b(a,s);l?i(l,t,r).then(e).catch(n):n(K.InvalidDefinition(`Invalid interceptor type. (${o})`))}).catch(n)});for(let r of e)r.mount===n.name&&r.verbs.forEach(e=>{n.app[e](r.path,(s,i,l)=>{const p=e=>{l(e)},c=e=>{e||l()},u=()=>{f(r.handler).then(n=>{let a=b(n,t);if(a)try{W(new a,t=>{(o=t[e](s,i))&&"function"==typeof o.then?o.then(e=>{c(e)}).catch(p):c(o)})}catch(e){p(e)}else p(K.InvalidDefinition(`Invalid route handler. ${r.handler}`))}).catch(p)};s.$stop=!1;let d=Ue[`${n.name}-interceptors`]||[];a(d,s,i).then(()=>{s.$stop?i.end():u()}).catch(e=>{s.stop?i.end():p(e)})})});n.app.use((e,t,r)=>{var s=new Error("Not Found");s.status=404,r(s)}),_.isProd,n.app.use((e,t,r)=>{r.status(e.status||500),t.xhr?r.status(500).send({error:e.toString()}):r.render("error",{message:e.message,error:e}),r.end()})})})})(),l.context.current().currentAssemblyBeingLoaded(""),l.registerAdo('{"name":"flair.server","file":"./flair.server{.min}.js","mainAssembly":"flair","desc":"True Object Oriented JavaScript","title":"Flair.js","version":"0.6.0","lupdate":"Sat, 11 May 2019 01:25:28 GMT","builder":{"name":"flairBuild","version":"1","format":"fasm","formatVersion":"1","contains":["init","func","type","vars","reso","asst","rout","sreg"]},"copyright":"(c) 2017-2019 Vikas Burman","license":"MIT","types":["flair.app.server.ExpressServer","flair.app.ServerHost","flair.api.RestHandler","flair.api.RestInterceptor","flair.boot.Middlewares","flair.boot.NodeEnv","flair.boot.ResHeaders","flair.boot.ServerRouter"],"resources":[],"assets":[],"routes":[]}'),"function"==typeof onLoadComplete&&onLoadComplete()});
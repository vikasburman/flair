/**
 * @preserve
 * Flair.js
 * True Object Oriented JavaScript
 * 
 * Assembly: flair.server
 *     File: ./flair.server.js
 *  Version: 0.50.55
 *  Sun, 05 May 2019 14:41:11 GMT
 * 
 * (c) 2017-2019 Vikas Burman
 * Licensed under MIT
 */
(()=>{"use strict";const e=void 0!==!0?require("flairjs"):(!0).flair,{Class:t,Struct:r,Enum:s,Interface:n,Mixin:o,Aspects:i,AppDomain:a,$$:l,attr:c,bring:p,Container:d,include:u,Port:f,on:v,post:h,telemetry:$,Reflector:m,Serializer:y,Tasks:g,as:b,is:w,isComplies:S,isDerivedFrom:x,isAbstract:O,isSealed:R,isStatic:E,isSingleton:A,isDeprecated:I,isImplements:j,isInstanceOf:P,isMixed:H,getAssembly:T,getAttr:F,getContext:B,getResource:C,getRoute:M,getType:z,ns:V,getTypeOf:k,getTypeName:D,typeOf:L,dispose:N,using:W,Args:q,Exception:J,noop:K,nip:U,nim:_,nie:G,event:Q}=e,{TaskInfo:X}=e.Tasks,{env:Y}=e.options,Z=Y.isServer||Y.isWorker?null:(!0).document,{forEachAsync:ee,replaceAll:te,splitAndTrim:re,findIndexByProp:se,findItemByProp:ne,which:oe,guid:ie,isArrowFunc:ae,isASyncFunc:le,sieve:ce,b64EncodeUnicode:pe,b64DecodeUnicode:de}=e.utils,{$$static:ue,$$abstract:fe,$$virtual:ve,$$override:he,$$sealed:$e,$$private:me,$$privateSet:ye,$$protected:ge,$$protectedSet:be,$$readonly:we,$$async:Se,$$overload:xe,$$enumerate:Oe,$$dispose:Re,$$post:Ee,$$on:Ae,$$timer:Ie,$$type:je,$$args:Pe,$$inject:He,$$resource:Te,$$asset:Fe,$$singleton:Be,$$serialize:Ce,$$deprecate:Me,$$session:ze,$$state:Ve,$$conditional:ke,$$noserialize:De,$$ns:Le}=l,Ne=a.context.current().name;let We=Y.isServer?__filename:(!0).document.currentScript.src.replace((!0).document.location.href,"./"),qe=We.substr(0,We.lastIndexOf("/")+1);a.loadPathOf("flair.server",qe);const Je=e=>{a.onError(e)};let Ke=JSON.parse('{"server":"flair.app.server.ExpressServer","server-http":{"enable":false,"port":80,"timeout":-1},"server-https":{"enable":false,"port":443,"timeout":-1,"privateKey":"","publicCert":""},"envVars":[],"envVarsloadOptions":{"overwrite":true},"mounts":{"main":"/"},"main-appSettings":[],"main-middlewares":[],"main-interceptors":[]}'),Ue=e.Port("settingsReader");if("function"==typeof Ue){let e=Ue("flair.server");e&&(Ke=Object.assign(Ke,e))}Ke=Object.freeze(Ke);let _e={};_e=Object.freeze(_e),a.context.current().currentAssemblyBeingLoaded("./flair.server{.min}.js");try{(async()=>{try{const e=await u("fs | x"),t=await u("http | x"),r=await u("https | x"),s=await u("http-shutdown | x");l("ns","flair.app.server"),o("ExpressServer",function(){let n=null,o=null,i=Ke["server-http"],c=Ke["server-https"];l("override"),this.start=(async l=>{if(l(),i.enable&&(n=t.createServer(this.app()),(n=s(n)).on("error",e=>{this.error(e)}),-1!==i.timeout&&(n.timeout=i.timeout)),c.enable){const t=e.readFileSync(a.resolvePath(c.privateKey),"utf8"),n=e.readFileSync(a.resolvePath(c.publicCert),"utf8"),i={key:t,cert:n};o=r.createServer(i,this.app()),(o=s(o)).on("error",e=>{this.error(e)}),-1!==c.timeout&&(o.timeout=c.timeout)}}),l("override"),this.ready=(e=>new Promise((t,r)=>{e();let s=i.port||80,l=process.env.PORT||c.port||443;n&&o?n.listen(s,()=>{o.listen(l,()=>{console.log(`${a.app().info.name}, v${a.app().info.version} (http: ${s}, https: ${l})`),t()})}):n?n.listen(s,()=>{console.log(`${a.app().info.name}, v${a.app().info.version} (http: ${s})`),t()}):o?o.listen(l,()=>{console.log(`${a.app().info.name}, v${a.app().info.version} (https: ${l})`),t()}):(console.log(`${a.app().info.name}, v${a.app().info.version}`),t())})),l("override"),this.stop=(async e=>{e(),n&&(console.log("http server is shutting down..."),n.shutdown(()=>{n=null,console.log("http server is cleanly shutdown!")})),o&&(console.log("https server is shutting down..."),o.shutdown(()=>{o=null,console.log("https server is cleanly shutdown!")}))})})}catch(e){Je(e)}})(),(async()=>{try{const{Host:e}=V("flair.app"),r=await u(Ke["server"]||"flair.app.server.ExpressServer"),s=await u("express | x");l("sealed"),l("ns","flair.app"),t("ServerHost",e,[r],function(){let e={};l("override"),this.construct=(e=>{e("Express","4.x")}),this.app=(()=>this.mounts["main"].app),this.mounts={get:()=>e,set:K},l("override"),this.boot=(async t=>{t();const r=(e,t)=>{let r=Ke[`${e}-appSettings`];if(r&&r.length>0)for(let e of r)t.set(e.name,e.value)};let n=s();r("main",n);let o="",i=null;for(let t of Object.keys(Ke.mounts))"main"===t?(o="/",i=n):(o=Ke.mounts[t],i=s()),e[t]=Object.freeze({name:t,root:o,app:i}),"main"!==t&&(r(t,i),n.use(o,i));e=Object.freeze(e)}),l("override"),this.dispose=(t=>{t(),e=null})})}catch(e){Je(e)}})(),(async()=>{try{const{Handler:e}=V("flair.app");l("ns","flair.api"),t("RestHandler",e,function(){l("virtual"),this.get=K,l("virtual"),this.post=K,l("virtual"),this.put=K,l("virtual"),this.delete=K})}catch(e){Je(e)}})(),(async()=>{try{l("ns","flair.api"),t("RestInterceptor",function(){l("virtual"),l("async"),this.run=K})}catch(e){Je(e)}})(),(async()=>{try{const{Bootware:e}=V("flair.app");l("sealed"),l("ns","flair.boot"),t("Middlewares",e,function(){l("override"),this.construct=(e=>{e("Express Middlewares",!0)}),l("override"),this.boot=(async e=>{let t=Ke[`${e.name}-middlewares`];if(t&&t.length>0){let r=null,s=null;for(let n of t)if(n.module)try{r=require(n.name),s=n.func?r[n.func]:r;let t=[],o=null;n.args=n.args||[];for(let e of n.args){if("string"==typeof e&&e.startsWith("return "))o=new Function(e)();else if("object"==typeof e)for(let t in e)e.hasOwnProperty(t)&&"string"==typeof(o=e[t])&&o.startsWith("return ")&&(o=new Function(e)(),e[t]=o);else o=e;t.push(o)}e.app.use(s(...t))}catch(e){throw J.OperationFailed(`Middleware ${n.module} load failed.`,e,this.boot)}}})})}catch(e){Je(e)}})(),(async()=>{try{const e=await u("node-env-file | x"),{Bootware:r}=V("flair.app");l("sealed"),l("ns","flair.boot"),t("NodeEnv",r,function(){l("override"),this.construct=(e=>{e("Node Server Environment")}),l("override"),this.boot=(async()=>{if(Ke.envVars.length>0)for(let t of Ke.envVars)e(a.resolvePath(t),Ke.envVarsLoadOptions)})})}catch(e){Je(e)}})(),(async()=>{try{const{Bootware:e}=V("flair.app");l("sealed"),l("ns","flair.boot"),t("ResHeaders",e,function(){l("override"),this.construct=(e=>{e("Server Response Headers",!0)}),l("override"),this.boot=(async e=>{let t=Ke[`${e.name}-resHeaders`];t&&t.length>0&&e.app.use((e,r,s)=>{for(let e of t)r.setHeader(e.name,e.value);s()})})})}catch(e){Je(e)}})(),(async()=>{try{const{Bootware:e}=V("flair.app"),{RestHandler:r,RestInterceptor:s}=V("flair.api");l("sealed"),l("ns","flair.boot"),t("ServerRouter",e,function(){let e=null;l("override"),this.construct=(e=>{e("Server Router",!0)}),l("override"),this.boot=(async t=>{e||(e=a.context.current().allRoutes(!0)).sort((e,t)=>e.index<t.index?-1:e.index>t.index?1:0);let n=!1;const o=(e,t,r)=>new Promise((s,n)=>{try{let o;(new e).run(t,r).then(()=>{t.$stop?n():s()}).catch(n)}catch(e){n(e)}}),i=(e,t,r)=>ee(e,(e,n,i)=>{u(i).then(a=>{let l=b(a,s);l?o(l,t,r).then(e).catch(n):n(J.InvalidDefinition(`Invalid interceptor type. (${i})`))}).catch(n)});for(let s of e)s.mount===t.name&&s.verbs.forEach(e=>{t.app[e](s.path,(o,a,l)=>{const c=e=>{l(e)},p=e=>{e||l()},d=()=>{u(s.handler).then(t=>{let i=b(t,r);if(i)try{W(new i,t=>{(n=t[e](o,a))&&"function"==typeof n.then?n.then(e=>{p(e)}).catch(c):p(n)})}catch(e){c(e)}else c(J.InvalidDefinition(`Invalid route handler. ${s.handler}`))}).catch(c)};o.$stop=!1;let f=Ke[`${t.name}-interceptors`]||[];i(f,o,a).then(()=>{o.$stop?a.end():d()}).catch(e=>{o.stop?a.end():c(e)})})});t.app.use((e,t,r)=>{var s=new Error("Not Found");s.status=404,r(s)}),Y.isProd,t.app.use((e,t,r)=>{r.status(e.status||500),t.xhr?r.status(500).send({error:e.toString()}):r.render("error",{message:e.message,error:e}),r.end()})})})}catch(e){Je(e)}})()}catch(e){Je(e)}a.context.current().currentAssemblyBeingLoaded(""),a.registerAdo('{"name":"flair.server","file":"./flair.server{.min}.js","mainAssembly":"flair","desc":"True Object Oriented JavaScript","title":"Flair.js","version":"0.50.55","lupdate":"Sun, 05 May 2019 14:41:11 GMT","builder":{"name":"<<name>>","version":"<<version>>","format":"fasm","formatVersion":"1","contains":["initializer","functions","types","enclosureVars","enclosedTypes","resources","assets","routes","selfreg"]},"copyright":"(c) 2017-2019 Vikas Burman","license":"MIT","types":["flair.app.server.ExpressServer","flair.app.ServerHost","flair.api.RestHandler","flair.api.RestInterceptor","flair.boot.Middlewares","flair.boot.NodeEnv","flair.boot.ResHeaders","flair.boot.ServerRouter"],"resources":[],"assets":[],"routes":[]}'),"function"==typeof onLoadComplete&&(onLoadComplete(),onLoadComplete=K)})();
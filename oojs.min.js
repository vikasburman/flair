/**
 * oojs.js
 * version 1.0.0
 * (C) 2017, Vikas Burman
 * MIT License 
 */
(function(){const def=env=>{let oojs={};oojs.Class=((className,inherits,factory)=>{"function"!=typeof factory&&(factory=inherits,inherits=null);let Class=function(...args){let Parent=Class.Inherits,_this={},bucket=[],meta={},props={},events=[];if(Parent&&(_this=new Parent(...args),Object.isFrozen(_this)))throw`${name} cannot inherit from a sealed class.`;const attr=(attrName,...args)=>{attrName=attrName.replace("@",""),bucket.push({name:attrName,Attr:getAttr(attrName),args:args})},getAttr=attrName=>{return attributes[attrName]||attributes.noop},applyAttr=targetName=>{let Attr=null,targetType=meta[targetName].type,attrArgs=null,attrInstance=null,decorator=null;for(let info of meta[targetName])if(Attr=info.Attr,attrArgs=info.args||[],attrInstance=new Attr(...attrArgs),decorator=attrInstance.decorator(),"function"==typeof decorator){let descriptor=Object.getOwnPropertyDescriptor(_this,targetName);decorator(_this,targetType,targetName,descriptor),Object.defineProperty(_this,targetName,descriptor)}},hasAttr=(attrName,meta)=>{let has=!1;for(let info of meta)if(info.name===attrName){has=!0;break}return has},isPatternMatched=(pattern,name)=>{let isMatched="*"===pattern;return isMatched||(pattern.indexOf("*")!==-1?(pattern=pattern.replace("*","[\\w]"),pRegEx=new RegExp(pattern),isMatched=pRegEx.test(name)):isMatched=pattern===name),isMatched},applyAspects=(funcName,funcAspects)=>{let fn=_this[funcName],before=[],after=[],around=[],instance=null,_fn=null;for(let funcAspect of funcAspects)instance=new funcAspect,_fn=instance.before(),"function"==typeof _fn&&before.push(_fn),_fn=instance.around(),"function"==typeof _fn&&around.push(_fn),_fn=instance.after(),"function"==typeof _fn&&after.push(_fn);around.length>0&&around.reverse();let weavedFn=function(...args){let error=null,result=null,ctx={obj:()=>{return _this},className:()=>{return className},funcName:()=>{return funcName},error:err=>{return err&&(error=err),error},result:value=>{return"undefined"!=typeof value&&(result=value),result},args:()=>{return args},data:{}};for(let beforeFn of before)try{beforeFn(ctx)}catch(err){error=err}let newFn=fn;for(let aroundFn of around)newFn=aroundFn(ctx,newFn);try{ctx.result(newFn(...args))}catch(err){error=err}for(let afterFn of after)try{afterFn(ctx)}catch(err){error=err}return ctx.result()}.bind(_this);return weavedFn},getClassAspects=()=>{let classAspects={};for(let entry in aspects)aspects.hasOwnProperty(entry)&&isPatternMatched(entry.split(".")[0],className)&&(classAspects[entry]=aspects[entry]);return classAspects},getFuncAspects=(classAspects,funcName)=>{let funcAspects=[];for(let entry in classAspects)classAspects.hasOwnProperty(entry)&&isPatternMatched(entry.split(".")[1],funcName)&&funcAspects.push(...classAspects[entry]);return funcAspects},weave=()=>{let classAspects=getClassAspects(),funcAspects=[];for(let entry in meta)meta.hasOwnProperty(entry)&&"func"===meta[entry].type&&["_constructor","_dispose"].indexOf(entry)===-1&&(funcAspects=getFuncAspects(classAspects,entry),funcAspects.length>0&&Object.defineProperty(_this,entry,{value:applyAspects(entry,funcAspects)}))};if(_this.func=((name,fn)=>{"constructor"===name&&(name="_"+name),"dispose"===name&&(name="_"+name),meta[name]=[].concat(bucket),meta[name].type="func",bucket=[];meta[name];if(hasAttr("override",meta[name])){let desc=Object.getOwnPropertyDescriptor(_this,name);if("function"!=typeof desc.value)throw`${name} is not a function to override.`;if(!desc.configurable)throw`${name} cannot override a sealed function.`;let base=_this[name].bind(_this);Object.defineProperty(_this,name,{value:function(...args){let fnArgs=[base].concat(args);return fn(...fnArgs)}.bind(_this)})}else{if(_this[name])throw`${name} already defined.`;Object.defineProperty(_this,name,{configurable:!0,enumerable:!0,writable:!1,value:fn})}applyAttr(name)}),_this.prop=((name,valueOrGetter,setter)=>{if(["constructor","dispose"].indexOf(name)!==-1)throw`${name} can only be defined as a function.`;meta[name]=[].concat(bucket),meta[name].type="prop",bucket=[];let attrs=meta[name];if(hasAttr("override",meta[name])){let desc=Object.getOwnPropertyDescriptor(_this,name);if("function"!=typeof desc.get)throw`${name} is not a property to override.`;if(!desc.configurable)throw`${name} cannot override a sealed property.`}else if(_this[name])throw`${name} already defined.`;if("function"!=typeof valueOrGetter){let prop=props[name]=valueOrGetter;Object.defineProperty(_this,name,{__proto__:null,configurable:!0,enumerable:!0,get:()=>{return prop},set:hasAttr("readonly",attrs)?value=>{throw`${name} is readonly.`}:value=>{prop=value}})}else Object.defineProperty(_this,name,{__proto__:null,configurable:!0,enumerable:!0,get:valueOrGetter,set:hasAttr("readonly",attrs)?value=>{throw`${name} is readonly.`}:value=>{"function"==typeof setter&&setter(value)}});applyAttr(name)}),_this.event=(name=>{if(["constructor","dispose"].indexOf(name)!==-1)throw`${name} can only be defined as a function.`;meta[name]=[],meta[name].type="event",bucket.length>0&&(console.warn(`Attributes can only be applied to properties or functions. ${name} is an event.`),bucket=[]);let _event=(...args)=>{let e={name:name,args:args,stop:!1};for(let handler of events)if(handler(e),e.stop)break};_event.Name=name,_event.subscribe=(fn=>{events.push(fn)}),_event.unsubscribe=(fn=>{let index=events.indexOf(fn);index!==-1&&events.splice(index,1)}),Object.defineProperty(_this,name,{configurable:!1,enumerable:!1,value:_event,writable:!1})}),factory.apply(_this,[attr]),_this._=_this._||{},_this._.instanceOf=_this._.instanceOf||[],Parent||_this._.instanceOf.push({name:"Object",type:Object,meta:[]}),_this._.instanceOf.push({name:className,type:Class,meta:meta}),_this._.Inherits=Class,"function"==typeof _this._constructor&&(_this._constructor(...args),delete _this._constructor),delete _this.func,delete _this.prop,"function"==typeof _this._dispose){_this._.dispose=_this._.dispose||[];let dispose=_this._dispose;_this._.dispose.push(dispose),delete _this._dispose}["Attribute","Aspect"].indexOf(inherits)===-1&&["Attribute","Aspect"].indexOf(className)===-1&&weave();for(let member in meta)if(meta.hasOwnProperty(member)&&hasAttr("seal",meta[member]))switch(meta[member].type){case"prop":Object.defineProperty(_this,member,{configurable:!1});break;case"func":"_constructor"===member?_this=Object.freeze(_this):Object.defineProperty(_this,member,{configurable:!1})}return _this};return Class.Inherits=inherits,Class.Name=className,Class}),oojs.using=((obj,where)=>{try{where(obj)}finally{if(obj._&&obj._.dispose.length>0){obj._.dispose.reverse();for(let dispose of obj._.dispose)dispose()}}});let attributes={};oojs.Attributes=(Attribute=>{attributes[Attribute.Name]=Attribute}),oojs.Attribute=oojs.Class("Attribute",function(){let decoratorFn=null;this.func("constructor",(...args)=>{this.args=args}),this.prop("args",[]),this.func("decorator",fn=>{return"function"==typeof fn&&(decoratorFn=fn),decoratorFn}),this.func("resetEventInterface",(source,target)=>{target.subscribe=source.subscribe,target.unsubscribe=source.unsubscribe,delete source.subscribe,delete source.unsubscribe})}),oojs.Attributes(oojs.Class("noop",oojs.Attribute,function(){})),oojs.Attributes(oojs.Class("async",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func"].indexOf(type)===-1)throw`@async attribute cannot be applied on ${type} members. (${name})`;if(["_constructor","_dispose"].indexOf(type)!==-1)throw`@async attribute cannot be applied on special function. (${name})`;let fn=descriptor.value;descriptor.value=function(...args){return new Promise((resolve,reject)=>{let fnArgs=[resolve,reject].concat(args);fn(...fnArgs)})}.bind(obj)})})),oojs.Attributes(oojs.Class("deprecate",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["_constructor","_dispose"].indexOf(type)!==-1)throw`@deprecate attribute cannot be applied on special function. (${name})`;switch(type){case"prop":if(descriptor.get){let _get=descriptor.get;descriptor.get=function(){return console.warn(`${name} is deprecated.`),_get()}.bind(obj)}if(descriptor.set){let _set=descriptor.set;descriptor.set=function(value){return console.warn(`${name} is deprecated.`),_set(value)}.bind(obj)}break;case"func":let fn=descriptor.value;descriptor.value=function(...args){console.warn(`${name} is deprecated.`),fn(...args)}.bind(obj);break;case"event":let ev=descriptor.value;descriptor.value=function(...args){console.warn(`${name} is deprecated.`),ev(...args)}.bind(obj),this.resetEventInterface(fn,descriptor.value)}})})),oojs.Attributes(oojs.Class("enumerate",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["_constructor","_dispose"].indexOf(type)!==-1)throw`@enumerate attribute cannot be applied on special function. (${name})`;let flag=this.args[0];descriptor.enumerable=flag})})),oojs.Attributes(oojs.Class("inject",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func"].indexOf(type)===-1)throw`@inject attribute cannot be applied on ${type} members. (${name})`;if(["_constructor","_dispose"].indexOf(type)!==-1)throw`@inject attribute cannot be applied on special function. (${name})`;let fn=descriptor.value,Type=this.args[0],typeArgs=this.args[1];Array.isArray(typeArgs)||(typeArgs=[typeArgs]),descriptor.value=function(...args){let instance=new Type(...typeArgs);fn(instance,...args)}.bind(obj)})})),oojs.Attributes(oojs.Class("multiinject",oojs.Attribute,function(){this.decorator((obj,type,name,descriptor)=>{if(["func"].indexOf(type)===-1)throw`@multiinject attribute cannot be applied on ${type} members. (${name})`;if(["_constructor","_dispose"].indexOf(type)!==-1)throw`@multiinject attribute cannot be applied on special function. (${name})`;let fn=descriptor.value,injections=this.args,instances=[],Type=null,typeArgs=null;for(entry of injections)Type=entry.Type,typeArgs=entry.typeArgs||[],Array.isArray(typeArgs)||(typeArgs=[typeArgs]),instances.push(new Type(...typeArgs));descriptor.value=function(...args){let cumulativeArgs=instances.concat(args);fn(...cumulativeArgs)}.bind(obj)})}));let aspects={};return oojs.Aspects=((pointcut,Aspect)=>{aspects[pointcut]||(aspects[pointcut]=[]),aspects[pointcut].push(Aspect)}),oojs.Aspect=oojs.Class("Aspect",function(){let beforeFn=null,afterFn=null,aroundFn=null;this.func("constructor",(...args)=>{this.args=args}),this.prop("args",[]),this.func("before",fn=>{return"function"==typeof fn&&(beforeFn=fn),beforeFn}),this.func("after",fn=>{return"function"==typeof fn&&(afterFn=fn),afterFn}),this.func("around",fn=>{return"function"==typeof fn&&(aroundFn=fn),aroundFn})}),env&&(env.Class=oojs.Class,env.using=oojs.using,env.Attribute=oojs.Attribute,env.Attributes=oojs.Attributes,env.Aspect=oojs.Aspect,env.Aspects=oojs.Aspects),Object.freeze(oojs)};"object"==typeof("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=def:"function"==typeof define&&define.amd?define(function(){return def}):this.oojs=def}).call(this);